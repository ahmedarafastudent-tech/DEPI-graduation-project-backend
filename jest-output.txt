
> backend@1.0.0 test
> jest

node.exe : (node:15712) [DEP0040] DeprecationWarning: The `punycode` 
module is deprecated. Please use a userland alternative instead.
At C:\Program Files\nodejs\npm.ps1:29 char:3
+   & $NODE_EXE $NPM_CLI_JS $args
+   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: ((node:15712) [D...native ins 
   tead.:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
 
(Use `node --trace-deprecation ...` to show where the warning was created)
  console.log
    AUTH DEBUG - decoded token: { id: '6901117d38609b4223a23d74', iat: 1761677693, exp: 1764269693 } computed userId: 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901117d38609b4223a23d6c', '6901117d38609b4223a23d74' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901117d38609b4223a23d74', iat: 1761677693, exp: 1764269693 } computed userId: 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901117d38609b4223a23d6c', '6901117d38609b4223a23d74' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:54:54.120Z [31merror[39m: Application error {"name":"Error","message":"Return period has expired (30 days)","stack":"Error: Return period has expired (30 days)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\returnController.js:30:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/returns","headers":{"host":"127.0.0.1:51021","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTdkMzg2MDliNDIyM2EyM2Q3NCIsImlhdCI6MTc2MTY3NzY5MywiZXhwIjoxNzY0MjY5NjkzfQ.Sdd1t69hIBbexk2GoS9Dc1TgfcDXFwLneiq1COyX8aA","content-type":"application/json","content-length":"153","connection":"close"},"query":{},"body":{"orderId":"6901117d38609b4223a23d77","items":[{"product":"6901117d38609b4223a23d76","quantity":1,"reason":"defective"}],"reason":"Product is defective"},"ip":"::ffff:127.0.0.1","userId":"6901117d38609b4223a23d74"}}
  console.log
    AUTH DEBUG - decoded token: { id: '6901117d38609b4223a23d6c', iat: 1761677693, exp: 1764269693 } computed userId: 6901117d38609b4223a23d6c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901117d38609b4223a23d6c', '6901117d38609b4223a23d74' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901117d38609b4223a23d6c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901117d38609b4223a23d6c', iat: 1761677693, exp: 1764269693 } computed userId: 6901117d38609b4223a23d6c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901117d38609b4223a23d6c', '6901117d38609b4223a23d74' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901117d38609b4223a23d6c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901117d38609b4223a23d74', iat: 1761677693, exp: 1764269693 } computed userId: 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901117d38609b4223a23d6c', '6901117d38609b4223a23d74' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901117d38609b4223a23d6c', iat: 1761677693, exp: 1764269693 } computed userId: 6901117d38609b4223a23d6c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901117d38609b4223a23d6c', '6901117d38609b4223a23d74' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901117d38609b4223a23d6c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901117d38609b4223a23d74', iat: 1761677693, exp: 1764269693 } computed userId: 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901117d38609b4223a23d6c', '6901117d38609b4223a23d74' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901117d38609b4223a23d74

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:54:54.832Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/returns/6901117e38609b4223a23e0e","headers":{"host":"127.0.0.1:51032","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTdkMzg2MDliNDIyM2EyM2Q3NCIsImlhdCI6MTc2MTY3NzY5MywiZXhwIjoxNzY0MjY5NjkzfQ.Sdd1t69hIBbexk2GoS9Dc1TgfcDXFwLneiq1COyX8aA","content-type":"application/json","content-length":"21","connection":"close"},"query":{},"body":{"status":"approved"},"ip":"::ffff:127.0.0.1","userId":"6901117d38609b4223a23d74"}}
FAIL __tests__/returns.test.js (7.319 s)
  Return Controller Tests
    POST /api/returns
      ظêأ should create a return request (292 ms)
      ├ù should not allow return after 30 days (161 ms)
    GET /api/returns
      ظêأ should get all returns for admin (153 ms)
      ظêأ should filter returns by status (146 ms)
    GET /api/returns/my-returns
      ظêأ should get user returns (122 ms)
    PUT /api/returns/:id
      ظêأ should update return status when admin (152 ms)
      ظêأ should not allow regular users to update return status (132 ms)

  ظù Return Controller Tests ظ║ POST /api/returns ظ║ should not allow 
return after 30 days

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

    [0m [90m 112 |[39m         [33m.[39msend(returnData)[33m;[39m
     [90m 113 |[39m
    [31m[1m>[22m[39m[90m 114 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 115 |[39m       expect(res[33m.[39mbody[33m.[39mmessage)[
33m.[39mtoContain([32m'Return period has expired'[39m)[33m;[39m
     [90m 116 |[39m     })[33m;[39m
     [90m 117 |[39m   })[33m;[39m[0m

      at toBe (__tests__/returns.test.js:114:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '69011181f71f8939acffd071', iat: 1761677698, exp: 1764269698 } computed userId: 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '69011181f71f8939acffd071', '69011182f71f8939acffd078' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '69011182f71f8939acffd078', iat: 1761677698, exp: 1764269698 } computed userId: 69011182f71f8939acffd078

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '69011181f71f8939acffd071', '69011182f71f8939acffd078' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 69011182f71f8939acffd078

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:54:58.531Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/subcategories","headers":{"host":"127.0.0.1:51047","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTgyZjcxZjg5MzlhY2ZmZDA3OCIsImlhdCI6MTc2MTY3NzY5OCwiZXhwIjoxNzY0MjY5Njk4fQ.UR35kEKZKyed0KmyZfHubfmjpIDlu3qsJZpjnLOuAMc","content-type":"application/json","content-length":"60","connection":"close"},"query":{},"body":{"name":"Smartphones","category":"69011182f71f8939acffd095"},"ip":"::ffff:127.0.0.1","userId":"69011182f71f8939acffd078"}}
  console.log
    AUTH DEBUG - decoded token: { id: '69011181f71f8939acffd071', iat: 1761677698, exp: 1764269698 } computed userId: 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '69011181f71f8939acffd071', '69011182f71f8939acffd078' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:54:58.669Z [31merror[39m: Application error {"name":"Error","message":"Invalid category","stack":"Error: Invalid category\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\subcategoryController.js:96:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/subcategories","headers":{"host":"127.0.0.1:51049","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTgxZjcxZjg5MzlhY2ZmZDA3MSIsImlhdCI6MTc2MTY3NzY5OCwiZXhwIjoxNzY0MjY5Njk4fQ.x38QWhkb3wLDomRg80SWieIiKid75lV76LKun40hwpY","content-type":"application/json","content-length":"60","connection":"close"},"query":{},"body":{"name":"Smartphones","category":"69011182f71f8939acffd0ab"},"ip":"::ffff:127.0.0.1","userId":"69011181f71f8939acffd071"}}
  console.log
    DBG SUBCATS [
      {
        id: '69011182f71f8939acffd0c2',
        category: { _id: new ObjectId("69011182f71f8939acffd0bf") },
        raw: undefined
      },
      {
        id: '69011182f71f8939acffd0c3',
        category: { _id: new ObjectId("69011182f71f8939acffd0bf") },
        raw: undefined
      }
    ]

      at log (controllers/subcategoryController.js:48:13)

  console.log
    DBG SUBCATS [
      {
        id: '69011182f71f8939acffd0db',
        category: { _id: new ObjectId("69011182f71f8939acffd0d8") },
        raw: undefined
      },
      {
        id: '69011182f71f8939acffd0dc',
        category: { _id: new ObjectId("69011182f71f8939acffd0d8") },
        raw: undefined
      }
    ]

      at log (controllers/subcategoryController.js:48:13)

2025-10-28T18:54:59.125Z [31merror[39m: Application error {"name":"Error","message":"Not Found - /api/subcategories/69011183f71f8939acffd10c","stack":"Error: Not Found - /api/subcategories/69011183f71f8939acffd10c\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\subcategoryController.js:74:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"GET","url":"/api/subcategories/69011183f71f8939acffd10c","headers":{"host":"127.0.0.1:51057","accept-encoding":"gzip, deflate","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1"}}
  console.log
    AUTH DEBUG - decoded token: { id: '69011181f71f8939acffd071', iat: 1761677698, exp: 1764269698 } computed userId: 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '69011181f71f8939acffd071', '69011182f71f8939acffd078' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '69011182f71f8939acffd078', iat: 1761677698, exp: 1764269698 } computed userId: 69011182f71f8939acffd078

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '69011181f71f8939acffd071', '69011182f71f8939acffd078' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 69011182f71f8939acffd078

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:54:59.428Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/subcategories/69011183f71f8939acffd139","headers":{"host":"127.0.0.1:51061","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTgyZjcxZjg5MzlhY2ZmZDA3OCIsImlhdCI6MTc2MTY3NzY5OCwiZXhwIjoxNzY0MjY5Njk4fQ.UR35kEKZKyed0KmyZfHubfmjpIDlu3qsJZpjnLOuAMc","content-type":"application/json","content-length":"24","connection":"close"},"query":{},"body":{"name":"Mobile Phones"},"ip":"::ffff:127.0.0.1","userId":"69011182f71f8939acffd078"}}
  console.log
    AUTH DEBUG - decoded token: { id: '69011181f71f8939acffd071', iat: 1761677698, exp: 1764269698 } computed userId: 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '69011181f71f8939acffd071', '69011182f71f8939acffd078' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 69011181f71f8939acffd071

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '69011182f71f8939acffd078', iat: 1761677698, exp: 1764269698 } computed userId: 69011182f71f8939acffd078

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '69011181f71f8939acffd071', '69011182f71f8939acffd078' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 69011182f71f8939acffd078

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:54:59.792Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"DELETE","url":"/api/subcategories/69011183f71f8939acffd169","headers":{"host":"127.0.0.1:51065","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTgyZjcxZjg5MzlhY2ZmZDA3OCIsImlhdCI6MTc2MTY3NzY5OCwiZXhwIjoxNzY0MjY5Njk4fQ.UR35kEKZKyed0KmyZfHubfmjpIDlu3qsJZpjnLOuAMc","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"69011182f71f8939acffd078"}}
FAIL __tests__/subcategory.test.js
  Subcategory Controller Tests
    POST /api/subcategories
      ظêأ should create a subcategory when admin (158 ms)
      ظêأ should not allow regular users to create subcategories (121 ms)
      ├ù should validate category existence (141 ms)
    GET /api/subcategories
      ظêأ should return all active subcategories (117 ms)
      ظêأ should filter subcategories by category (117 ms)
    GET /api/subcategories/:id
      ظêأ should get subcategory by ID (106 ms)
      ├ù should return 404 for non-existent subcategory (106 ms)
    PUT /api/subcategories/:id
      ظêأ should update subcategory when admin (145 ms)
      ظêأ should not allow regular users to update subcategories (184 ms)
    DELETE /api/subcategories/:id
      ظêأ should delete subcategory when admin (196 ms)
      ظêأ should not allow regular users to delete subcategories (148 ms)

  ظù Subcategory Controller Tests ظ║ POST /api/subcategories ظ║ should 
validate category existence

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

    [0m [90m 110 |[39m         })[33m;[39m
     [90m 111 |[39m
    [31m[1m>[22m[39m[90m 112 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 113 |[39m     })[33m;[39m
     [90m 114 |[39m   })[33m;[39m
     [90m 115 |[39m[0m

      at toBe (__tests__/subcategory.test.js:112:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Subcategory Controller Tests ظ║ GET /api/subcategories/:id ظ║ 
should return 404 for non-existent subcategory

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 182 |[39m         [33m.[39m[36mget[39m([32m`/api/subc
ategories/${mongoose.Types.ObjectId()}`[39m)[33m;[39m
     [90m 183 |[39m
    [31m[1m>[22m[39m[90m 184 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 185 |[39m     })[33m;[39m
     [90m 186 |[39m   })[33m;[39m
     [90m 187 |[39m[0m

      at toBe (__tests__/subcategory.test.js:184:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '6901118645ea81b5ff4054f9', iat: 1761677702, exp: 1764269702 } computed userId: 6901118645ea81b5ff4054f9

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901118645ea81b5ff4054f9', '6901118645ea81b5ff4054fd' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118645ea81b5ff4054f9

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901118745ea81b5ff405515', iat: 1761677703, exp: 1764269703 } computed userId: 6901118745ea81b5ff405515

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 4 ids: [
      '6901118645ea81b5ff4054f9',
      '6901118645ea81b5ff4054fd',
      '6901118745ea81b5ff405515',
      '6901118745ea81b5ff405517'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118745ea81b5ff405515

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:03.517Z [31merror[39m: Application error {"name":"Error","message":"Product not found","stack":"Error: Product not found\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\orderController.js:29:13\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/orders","headers":{"host":"127.0.0.1:51081","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTg3NDVlYTgxYjVmZjQwNTUxNSIsImlhdCI6MTc2MTY3NzcwMywiZXhwIjoxNzY0MjY5NzAzfQ.h0ect9UUW-_GNJ49iCkrR4alJB7ofD7k0Mwq4RocOhI","content-type":"application/json","content-length":"217","connection":"close"},"query":{},"body":{"orderItems":[{"product":"507f1f77bcf86cd799439011","qty":2}],"shippingAddress":{"address":"123 Test St","city":"Test City","postalCode":"12345","country":"Test Country"},"paymentMethod":"PayPal","totalPrice":199.98},"ip":"::ffff:127.0.0.1","userId":"6901118745ea81b5ff405515"}}
  console.log
    AUTH DEBUG - decoded token: { id: '6901118745ea81b5ff40552c', iat: 1761677703, exp: 1764269703 } computed userId: 6901118745ea81b5ff40552c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 6 ids: [
      '6901118645ea81b5ff4054f9',
      '6901118645ea81b5ff4054fd',
      '6901118745ea81b5ff405515',
      '6901118745ea81b5ff405517',
      '6901118745ea81b5ff40552c',
      '6901118745ea81b5ff40552e'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118745ea81b5ff40552c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901118745ea81b5ff40554b', iat: 1761677704, exp: 1764269704 } computed userId: 6901118745ea81b5ff40554b

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 8 ids: [
      '6901118645ea81b5ff4054f9',
      '6901118645ea81b5ff4054fd',
      '6901118745ea81b5ff405515',
      '6901118745ea81b5ff405517',
      '6901118745ea81b5ff40552c',
      '6901118745ea81b5ff40552e',
      '6901118745ea81b5ff40554b',
      '6901118845ea81b5ff40554d'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118745ea81b5ff40554b

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901118845ea81b5ff405570', iat: 1761677704, exp: 1764269704 } computed userId: 6901118845ea81b5ff405570

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 11 ids: [
      '6901118645ea81b5ff4054f9',
      '6901118645ea81b5ff4054fd',
      '6901118745ea81b5ff405515',
      '6901118745ea81b5ff405517',
      '6901118745ea81b5ff40552c',
      '6901118745ea81b5ff40552e',
      '6901118745ea81b5ff40554b',
      '6901118845ea81b5ff40554d',
      '6901118845ea81b5ff405567',
      '6901118845ea81b5ff405569',
      '6901118845ea81b5ff405570'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118845ea81b5ff405570

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:04.909Z [31merror[39m: Application error {"name":"Error","message":"Not authorized to view this order","stack":"Error: Not authorized to view this order\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\orderController.js:61:13\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"GET","url":"/api/orders/6901118845ea81b5ff40556d","headers":{"host":"127.0.0.1:51087","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTg4NDVlYTgxYjVmZjQwNTU3MCIsImlhdCI6MTc2MTY3NzcwNCwiZXhwIjoxNzY0MjY5NzA0fQ.vRfnFEE89yS4cAMU9nYrYCafbwfBn6Kre4RDOGVkXgo","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"6901118845ea81b5ff405570"}}
FAIL __tests__/orders.test.js
  Order Endpoints
    POST /api/orders
      ظêأ should create a new order (502 ms)
      ├ù should not create order with invalid product (453 ms)
    GET /api/orders/myorders
      ظêأ should get all orders for user (397 ms)
    GET /api/orders/:id
      ظêأ should get order by id (442 ms)
      ├ù should not get order of another user (560 ms)

  ظù Order Endpoints ظ║ POST /api/orders ظ║ should not create order 
with invalid product

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 85 |[39m         })[33m;[39m
     [90m 86 |[39m
    [31m[1m>[22m[39m[90m 87 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m    |[39m                              [31m[1m^[22m[39m
     [90m 88 |[39m     })[33m;[39m
     [90m 89 |[39m   })[33m;[39m
     [90m 90 |[39m[0m

      at toBe (__tests__/orders.test.js:87:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Order Endpoints ظ║ GET /api/orders/:id ظ║ should not get order of 
another user

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 500

    [0m [90m 185 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${otherUser.token}`[39m)[33m;[39m
     [90m 186 |[39m
    [31m[1m>[22m[39m[90m 187 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 188 |[39m     })[33m;[39m
     [90m 189 |[39m   })[33m;[39m
     [90m 190 |[39m })[33m;[39m[0m

      at toBe (__tests__/orders.test.js:187:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '6901118ba47d6c65c8803ee2', iat: 1761677707, exp: 1764269707 } computed userId: 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901118ba47d6c65c8803ee2', '6901118ba47d6c65c8803ee8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901118ba47d6c65c8803ee2', iat: 1761677707, exp: 1764269707 } computed userId: 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901118ba47d6c65c8803ee2', '6901118ba47d6c65c8803ee8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:08.197Z [31merror[39m: Application error {"name":"Error","message":"Order not found","stack":"Error: Order not found\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\paymentController.js:53:13\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/payments/create-payment","headers":{"host":"127.0.0.1:51103","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMThiYTQ3ZDZjNjVjODgwM2VlMiIsImlhdCI6MTc2MTY3NzcwNywiZXhwIjoxNzY0MjY5NzA3fQ.wiPFHlVn7yGQkTxRuiSZQhIO6Psr2FXjIVj7Xz994Rs","content-type":"application/json","content-length":"82","connection":"close"},"query":{},"body":{"orderId":"6901118ca47d6c65c8803f09","returnUrl":"http://localhost:3000/success"},"ip":"::ffff:127.0.0.1","userId":"6901118ba47d6c65c8803ee2"}}
  console.log
    AUTH DEBUG - decoded token: { id: '6901118ba47d6c65c8803ee8', iat: 1761677708, exp: 1764269708 } computed userId: 6901118ba47d6c65c8803ee8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901118ba47d6c65c8803ee2', '6901118ba47d6c65c8803ee8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118ba47d6c65c8803ee8

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:08.390Z [31merror[39m: Application error {"name":"Error","message":"Not authorized to access this order","stack":"Error: Not authorized to access this order\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\paymentController.js:60:13\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/payments/create-payment","headers":{"host":"127.0.0.1:51105","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMThiYTQ3ZDZjNjVjODgwM2VlOCIsImlhdCI6MTc2MTY3NzcwOCwiZXhwIjoxNzY0MjY5NzA4fQ.Bd4lecC0WMQFFg3-dyD1f9CklPoAZTpzfkzN8Ul-FWE","content-type":"application/json","content-length":"82","connection":"close"},"query":{},"body":{"orderId":"6901118ca47d6c65c8803f21","returnUrl":"http://localhost:3000/success"},"ip":"::ffff:127.0.0.1","userId":"6901118ba47d6c65c8803ee8"}}
  console.log
    AUTH DEBUG - decoded token: { id: '6901118ba47d6c65c8803ee2', iat: 1761677707, exp: 1764269707 } computed userId: 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901118ba47d6c65c8803ee2', '6901118ba47d6c65c8803ee8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901118ba47d6c65c8803ee2', iat: 1761677707, exp: 1764269707 } computed userId: 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901118ba47d6c65c8803ee2', '6901118ba47d6c65c8803ee8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901118ba47d6c65c8803ee2

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:09.243Z [31merror[39m: Application error {"name":"Error","message":"Order is not paid","stack":"Error: Order is not paid\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\paymentController.js:315:28\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/payments/refund","headers":{"host":"127.0.0.1:51118","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMThiYTQ3ZDZjNjVjODgwM2VlMiIsImlhdCI6MTc2MTY3NzcwNywiZXhwIjoxNzY0MjY5NzA3fQ.wiPFHlVn7yGQkTxRuiSZQhIO6Psr2FXjIVj7Xz994Rs","content-type":"application/json","content-length":"96","connection":"close"},"query":{},"body":{"orderId":"6901118da47d6c65c8803fa6","refundAmount":99.99,"reason":"Customer requested refund"},"ip":"::ffff:127.0.0.1","userId":"6901118ba47d6c65c8803ee2"}}
2025-10-28T18:55:09.476Z [31merror[39m: Application error {"name":"Error","message":"Payment verification failed","stack":"Error: Payment verification failed\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\paymentController.js:216:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/payments/ipn","headers":{"host":"127.0.0.1:51122","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"85","connection":"close"},"query":{},"body":{"tran_ref":"invalid_ref","cart_id":"6901118da47d6c65c8803fd2","response_status":"D"},"ip":"::ffff:127.0.0.1"}}
FAIL __tests__/payment.test.js
  Payment Controller Tests
    POST /api/payments/create-payment
      ظêأ should create a payment page (171 ms)
      ├ù should validate order existence (127 ms)
      ├ù should validate order ownership (242 ms)
    POST /api/payments/verify-payment
      ظêأ should verify successful payment (237 ms)
      ظêأ should handle failed payment verification (102 ms)
      ظêأ should validate order existence (90 ms)
      ظêأ should require tran_ref and orderId (91 ms)
    POST /api/payments/refund
      ظêأ should process refund successfully (130 ms)
      ظêأ should not allow refund for unpaid order (173 ms)
    POST /api/payments/ipn
      ظêأ should handle IPN notification (114 ms)
      ├ù should handle invalid IPN notification (109 ms)
    GET /api/payments/config
      ظêأ should return PayTabs configuration (83 ms)

  ظù Payment Controller Tests ظ║ POST /api/payments/create-payment ظ║ 
should validate order existence

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 64 |[39m   [33m.[39msend({ orderId[33m:[39m 
[36mnew[39m mongoose[33m.[39m[33mTypes[39m[33m.[39m[33mObjectId[
39m()[33m.[39mtoString()[33m,[39m returnUrl[33m:[39m 
[32m'http://localhost:3000/success'[39m })[33m;[39m
     [90m 65 |[39m
    [31m[1m>[22m[39m[90m 66 |[39m       
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m    |[39m                          [31m[1m^[22m[39m
     [90m 67 |[39m     })[33m;[39m
     [90m 68 |[39m
     [90m 69 |[39m     it([32m'should validate order 
ownership'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at toBe (__tests__/payment.test.js:66:26)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Payment Controller Tests ظ║ POST /api/payments/create-payment ظ║ 
should validate order ownership

    expect(received).toBe(expected) // Object.is equality

    Expected: 403
    Received: 500

    [0m [90m 81 |[39m   [33m.[39msend({ orderId[33m:[39m 
userOrder[33m.[39m_id[33m.[39mtoString()[33m,[39m 
returnUrl[33m:[39m [32m'http://localhost:3000/success'[39m 
})[33m;[39m
     [90m 82 |[39m
    [31m[1m>[22m[39m[90m 83 |[39m       
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m403[39m)[33m;[39m
     [90m    |[39m                          [31m[1m^[22m[39m
     [90m 84 |[39m     })[33m;[39m
     [90m 85 |[39m   })[33m;[39m
     [90m 86 |[39m[0m

      at toBe (__tests__/payment.test.js:83:26)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Payment Controller Tests ظ║ POST /api/payments/ipn ظ║ should 
handle invalid IPN notification

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

    [0m [90m 203 |[39m         [33m.[39msend({ tran_ref[33m:[39m 
[32m'invalid_ref'[39m[33m,[39m cart_id[33m:[39m 
testOrder[33m.[39m_id[33m.[39mtoString()[33m,[39m 
response_status[33m:[39m [32m'D'[39m })[33m;[39m
     [90m 204 |[39m
    [31m[1m>[22m[39m[90m 205 |[39m       
expect(res[33m.[39mstatus)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                          [31m[1m^[22m[39m
     [90m 206 |[39m     })[33m;[39m
     [90m 207 |[39m   })[33m;[39m
     [90m 208 |[39m[0m

      at toBe (__tests__/payment.test.js:205:26)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

  console.log
    Controller - Looking for product ID: 690111912d38fc2f8366a81f

      at log (controllers/wishlistController.js:25:11)

  console.log
    Controller - Found product: 690111912d38fc2f8366a81f

      at log (controllers/wishlistController.js:35:11)

  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

  console.log
    Controller - Looking for product ID: 690111912d38fc2f8366a83c

      at log (controllers/wishlistController.js:25:11)

  console.log
    Controller - Found product: 690111912d38fc2f8366a83c

      at log (controllers/wishlistController.js:35:11)

  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

  console.log
    Controller - Looking for product ID: 690111912d38fc2f8366a83c

      at log (controllers/wishlistController.js:25:11)

  console.log
    Controller - Found product: 690111912d38fc2f8366a83c

      at log (controllers/wishlistController.js:35:11)

  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:14.227Z [31merror[39m: Application error {"name":"Error","message":"Wishlist not found","stack":"Error: Wishlist not found\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\wishlistController.js:69:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"DELETE","url":"/api/wishlist/690111922d38fc2f8366a87d","headers":{"host":"127.0.0.1:51149","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTkwMmQzOGZjMmY4MzY2YTdlMSIsImlhdCI6MTc2MTY3NzcxMiwiZXhwIjoxNzY0MjY5NzEyfQ.ZoSc-93_1AfZLAy4KHwPUlQQ9U9CFcQ4LeBUNH5_4Ck","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"690111902d38fc2f8366a7e1"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111902d38fc2f8366a7e1', iat: 1761677712, exp: 1764269712 } computed userId: 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111902d38fc2f8366a7e1', '690111902d38fc2f8366a7e6' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111902d38fc2f8366a7e1

      at log (middleware/authMiddleware.js:85:15)

FAIL __tests__/wishlist.test.js
  Wishlist Controller Tests
    GET /api/wishlist
      ظêأ should get empty wishlist for new user (238 ms)
      ظêأ should return existing wishlist items (175 ms)
    POST /api/wishlist
      ظêأ should add item to wishlist (231 ms)
      ظêأ should not add duplicate items (367 ms)
    DELETE /api/wishlist/:productId
      ظêأ should remove item from wishlist (242 ms)
      ├ù should return 404 for non-existent wishlist (154 ms)
    POST /api/wishlist/:productId/move-to-cart
      ظêأ should move item from wishlist to cart (297 ms)

  ظù Wishlist Controller Tests ظ║ DELETE /api/wishlist/:productId ظ║ 
should return 404 for non-existent wishlist

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 149 |[39m         
[33m.[39m[36mset[39m([32m'Authorization'[39m[33m,[39m 
[32m`Bearer ${token}`[39m)[33m;[39m
     [90m 150 |[39m
    [31m[1m>[22m[39m[90m 151 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 152 |[39m     })[33m;[39m
     [90m 153 |[39m   })[33m;[39m
     [90m 154 |[39m[0m

      at toBe (__tests__/wishlist.test.js:151:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

2025-10-28T18:55:18.565Z [31merror[39m: Application error {"name":"Error","message":"Email already subscribed","stack":"Error: Email already subscribed\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\newsletterController.js:28:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/newsletter/subscribe","headers":{"host":"127.0.0.1:51166","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"57","connection":"close"},"query":{},"body":{"email":"subscriber@example.com","preferences":["news"]},"ip":"::ffff:127.0.0.1"}}
2025-10-28T18:55:19.027Z [31merror[39m: Application error {"name":"Error","message":"Email not found in subscription list","stack":"Error: Email not found in subscription list\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\newsletterController.js:71:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/newsletter/unsubscribe","headers":{"host":"127.0.0.1:51170","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"35","connection":"close"},"query":{},"body":{"email":"nonexistent@example.com"},"ip":"::ffff:127.0.0.1"}}
2025-10-28T18:55:19.510Z [31merror[39m: Application error {"name":"Error","message":"Email not found in subscription list","stack":"Error: Email not found in subscription list\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\newsletterController.js:117:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/newsletter/preferences","headers":{"host":"127.0.0.1:51174","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"58","connection":"close"},"query":{},"body":{"email":"nonexistent@example.com","preferences":["news"]},"ip":"::ffff:127.0.0.1"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111961dfcbbb39a6a0c6e', iat: 1761677718, exp: 1764269718 } computed userId: 690111961dfcbbb39a6a0c6e

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 1 ids: [ '690111961dfcbbb39a6a0c6e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111961dfcbbb39a6a0c6e

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111971dfcbbb39a6a0cf3', iat: 1761677719, exp: 1764269719 } computed userId: 690111971dfcbbb39a6a0cf3

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 1 ids: [ '690111961dfcbbb39a6a0c6e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: false null

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:19.968Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:93:16)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"GET","url":"/api/newsletter/subscribers","headers":{"host":"127.0.0.1:51179","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTk3MWRmY2JiYjM5YTZhMGNmMyIsImlhdCI6MTc2MTY3NzcxOSwiZXhwIjoxNzY0MjY5NzE5fQ._AZJddG5LKjM8oZkI43ZNhnQTMxm-_006MZ7Zl3tJN0","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111961dfcbbb39a6a0c6e', iat: 1761677718, exp: 1764269718 } computed userId: 690111961dfcbbb39a6a0c6e

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 1 ids: [ '690111961dfcbbb39a6a0c6e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111961dfcbbb39a6a0c6e

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111981dfcbbb39a6a0d1f', iat: 1761677720, exp: 1764269720 } computed userId: 690111981dfcbbb39a6a0d1f

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 1 ids: [ '690111961dfcbbb39a6a0c6e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: false null

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:20.377Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:93:16)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/newsletter/send","headers":{"host":"127.0.0.1:51183","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTk4MWRmY2JiYjM5YTZhMGQxZiIsImlhdCI6MTc2MTY3NzcyMCwiZXhwIjoxNzY0MjY5NzIwfQ.6pP26dRnCiPJOwkgfMcaNAztTB0huh1gGO5ATvdXaoo","content-type":"application/json","content-length":"60","connection":"close"},"query":{},"body":{"subject":"Test Newsletter","content":"Newsletter content"},"ip":"::ffff:127.0.0.1"}}
FAIL __tests__/newsletter.test.js (5.598 s)
  Newsletter Controller Tests
    POST /api/newsletter/subscribe
      ظêأ should subscribe a new email (173 ms)
      ├ù should not allow duplicate subscriptions (222 ms)
    POST /api/newsletter/unsubscribe
      ظêأ should unsubscribe an email (237 ms)
      ├ù should handle unsubscribe for non-existent email (193 ms)
    PUT /api/newsletter/preferences
      ظêأ should update subscriber preferences (255 ms)
      ├ù should handle update for non-existent email (240 ms)
    GET /api/newsletter/subscribers
      ظêأ should return all subscribers for admin (210 ms)
      ظêأ should not allow access without admin privileges (224 ms)
    POST /api/newsletter/send
      ظêأ should send newsletter to subscribers (185 ms)
      ظêأ should not allow sending without admin privileges (199 ms)

  ظù Newsletter Controller Tests ظ║ POST /api/newsletter/subscribe ظ║ 
should not allow duplicate subscriptions

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

    [0m [90m 66 |[39m         })[33m;[39m
     [90m 67 |[39m
    [31m[1m>[22m[39m[90m 68 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m    |[39m                              [31m[1m^[22m[39m
     [90m 69 |[39m     })[33m;[39m
     [90m 70 |[39m   })[33m;[39m
     [90m 71 |[39m[0m

      at toBe (__tests__/newsletter.test.js:68:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Newsletter Controller Tests ظ║ POST /api/newsletter/unsubscribe 
ظ║ should handle unsubscribe for non-existent email

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m  97 |[39m         })[33m;[39m
     [90m  98 |[39m
    [31m[1m>[22m[39m[90m  99 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 100 |[39m     })[33m;[39m
     [90m 101 |[39m   })[33m;[39m
     [90m 102 |[39m[0m

      at toBe (__tests__/newsletter.test.js:99:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Newsletter Controller Tests ظ║ PUT /api/newsletter/preferences ظ║ 
should handle update for non-existent email

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 132 |[39m         })[33m;[39m
     [90m 133 |[39m
    [31m[1m>[22m[39m[90m 134 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 135 |[39m     })[33m;[39m
     [90m 136 |[39m   })[33m;[39m
     [90m 137 |[39m[0m

      at toBe (__tests__/newsletter.test.js:134:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '6901119bc8e2eeea208d0c67', iat: 1761677724, exp: 1764269724 } computed userId: 6901119bc8e2eeea208d0c67

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901119bc8e2eeea208d0c67', '6901119cc8e2eeea208d0c6c' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901119bc8e2eeea208d0c67

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901119cc8e2eeea208d0c6c', iat: 1761677724, exp: 1764269724 } computed userId: 6901119cc8e2eeea208d0c6c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901119bc8e2eeea208d0c67', '6901119cc8e2eeea208d0c6c' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901119cc8e2eeea208d0c6c

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:24.392Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/shipping","headers":{"host":"127.0.0.1:51198","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTljYzhlMmVlZWEyMDhkMGM2YyIsImlhdCI6MTc2MTY3NzcyNCwiZXhwIjoxNzY0MjY5NzI0fQ.2K3rOMkawONWb7-o_Q2JnxVkhM0uWxEZCTgy0oEXFs4","content-type":"application/json","content-length":"57","connection":"close"},"query":{},"body":{"name":"Express Shipping","carrier":"DHL","baseRate":10},"ip":"::ffff:127.0.0.1","userId":"6901119cc8e2eeea208d0c6c"}}
  console.log
    AUTH DEBUG - decoded token: { id: '6901119bc8e2eeea208d0c67', iat: 1761677724, exp: 1764269724 } computed userId: 6901119bc8e2eeea208d0c67

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901119bc8e2eeea208d0c67', '6901119cc8e2eeea208d0c6c' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901119bc8e2eeea208d0c67

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '6901119cc8e2eeea208d0c6c', iat: 1761677724, exp: 1764269724 } computed userId: 6901119cc8e2eeea208d0c6c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '6901119bc8e2eeea208d0c67', '6901119cc8e2eeea208d0c6c' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 6901119cc8e2eeea208d0c6c

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:24.997Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/shipping/6901119cc8e2eeea208d0cce","headers":{"host":"127.0.0.1:51207","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMTljYzhlMmVlZWEyMDhkMGM2YyIsImlhdCI6MTc2MTY3NzcyNCwiZXhwIjoxNzY0MjY5NzI0fQ.2K3rOMkawONWb7-o_Q2JnxVkhM0uWxEZCTgy0oEXFs4","content-type":"application/json","content-length":"14","connection":"close"},"query":{},"body":{"baseRate":6},"ip":"::ffff:127.0.0.1","userId":"6901119cc8e2eeea208d0c6c"}}
2025-10-28T18:55:25.268Z [31merror[39m: Application error {"name":"Error","message":"Shipping method not available for this region","stack":"Error: Shipping method not available for this region\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\shippingController.js:114:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/shipping/calculate","headers":{"host":"127.0.0.1:51211","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"65","connection":"close"},"query":{},"body":{"methodId":"6901119dc8e2eeea208d0cf4","weight":2,"region":"USA"},"ip":"::ffff:127.0.0.1"}}
2025-10-28T18:55:25.404Z [31merror[39m: Application error {"name":"Error","message":"Invalid weight","stack":"Error: Invalid weight\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\shippingController.js:119:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/shipping/calculate","headers":{"host":"127.0.0.1:51213","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"66","connection":"close"},"query":{},"body":{"methodId":"6901119dc8e2eeea208d0d04","weight":-1,"region":"USA"},"ip":"::ffff:127.0.0.1"}}
FAIL __tests__/shipping.test.js
  Shipping Controller Tests
    POST /api/shipping
      ظêأ should create a shipping method when admin (175 ms)
      ظêأ should not allow regular users to create shipping methods (127 
ms)
    GET /api/shipping
      ظêأ should return all active shipping methods (108 ms)
      ظêأ should filter shipping methods by region (143 ms)
    PUT /api/shipping/:id
      ظêأ should update shipping method when admin (209 ms)
      ظêأ should not allow regular users to update shipping methods (153 
ms)
    POST /api/shipping/calculate
      ظêأ should calculate shipping cost correctly (122 ms)
      ├ù should return 404 for invalid shipping method (153 ms)
      ├ù should validate weight input (111 ms)

  ظù Shipping Controller Tests ظ║ POST /api/shipping/calculate ظ║ 
should return 404 for invalid shipping method

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 194 |[39m         })[33m;[39m
     [90m 195 |[39m
    [31m[1m>[22m[39m[90m 196 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 197 |[39m     })[33m;[39m
     [90m 198 |[39m
     [90m 199 |[39m     it([32m'should validate weight 
input'[39m[33m,[39m [36masync[39m () [33m=>[39m {[0m

      at toBe (__tests__/shipping.test.js:196:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Shipping Controller Tests ظ║ POST /api/shipping/calculate ظ║ 
should validate weight input

    expect(received).toBe(expected) // Object.is equality

    Expected: 400
    Received: 500

    [0m [90m 206 |[39m         })[33m;[39m
     [90m 207 |[39m
    [31m[1m>[22m[39m[90m 208 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m400[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 209 |[39m     })[33m;[39m
     [90m 210 |[39m   })[33m;[39m
     [90m 211 |[39m })[33m;[39m[0m

      at toBe (__tests__/shipping.test.js:208:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a0bfd4fdcde867637c', iat: 1761677728, exp: 1764269728 } computed userId: 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a0bfd4fdcde867637c', '690111a0bfd4fdcde867637e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a0bfd4fdcde867637c', iat: 1761677728, exp: 1764269728 } computed userId: 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a0bfd4fdcde867637c', '690111a0bfd4fdcde867637e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a0bfd4fdcde867637e', iat: 1761677728, exp: 1764269728 } computed userId: 690111a0bfd4fdcde867637e

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a0bfd4fdcde867637c', '690111a0bfd4fdcde867637e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a0bfd4fdcde867637e

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:28.822Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/tax","headers":{"host":"127.0.0.1:51231","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWEwYmZkNGZkY2RlODY3NjM3ZSIsImlhdCI6MTc2MTY3NzcyOCwiZXhwIjoxNzY0MjY5NzI4fQ.L1xHAAz978mlBbo9qaiFxb59p_QzNBndSM-S-X_vdoA","content-type":"application/json","content-length":"34","connection":"close"},"query":{},"body":{"name":"US Sales Tax","rate":8.5},"ip":"::ffff:127.0.0.1","userId":"690111a0bfd4fdcde867637e"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111a0bfd4fdcde867637c', iat: 1761677728, exp: 1764269728 } computed userId: 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a0bfd4fdcde867637c', '690111a0bfd4fdcde867637e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a0bfd4fdcde867637c', iat: 1761677728, exp: 1764269728 } computed userId: 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a0bfd4fdcde867637c', '690111a0bfd4fdcde867637e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a0bfd4fdcde867637c', iat: 1761677728, exp: 1764269728 } computed userId: 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a0bfd4fdcde867637c', '690111a0bfd4fdcde867637e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a0bfd4fdcde867637c

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a0bfd4fdcde867637e', iat: 1761677728, exp: 1764269728 } computed userId: 690111a0bfd4fdcde867637e

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a0bfd4fdcde867637c', '690111a0bfd4fdcde867637e' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a0bfd4fdcde867637e

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:29.351Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/tax/690111a1bfd4fdcde86763ff","headers":{"host":"127.0.0.1:51239","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWEwYmZkNGZkY2RlODY3NjM3ZSIsImlhdCI6MTc2MTY3NzcyOCwiZXhwIjoxNzY0MjY5NzI4fQ.L1xHAAz978mlBbo9qaiFxb59p_QzNBndSM-S-X_vdoA","content-type":"application/json","content-length":"10","connection":"close"},"query":{},"body":{"rate":9},"ip":"::ffff:127.0.0.1","userId":"690111a0bfd4fdcde867637e"}}
2025-10-28T18:55:29.654Z [31merror[39m: Application error {"name":"Error","message":"No tax rate found for this region","stack":"Error: No tax rate found for this region\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\taxController.js:131:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/tax/calculate","headers":{"host":"127.0.0.1:51245","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"35","connection":"close"},"query":{},"body":{"region":"Unknown","subtotal":100},"ip":"::ffff:127.0.0.1"}}
FAIL __tests__/tax.test.js
  Tax Controller Tests
    POST /api/tax
      ظêأ should create a tax rate when admin (137 ms)
      ظêأ should handle multiple default tax rates for same region (134 
ms)
      ظêأ should not allow regular users to create tax rates (116 ms)
    GET /api/tax
      ظêأ should return all active tax rates (133 ms)
      ظêأ should filter tax rates by region (135 ms)
    PUT /api/tax/:id
      ظêأ should update tax rate when admin (140 ms)
      ظêأ should not allow regular users to update tax rates (117 ms)
    POST /api/tax/calculate
      ظêأ should calculate percentage tax correctly (92 ms)
      ظêأ should apply threshold correctly (106 ms)
      ├ù should handle missing tax rate for region (115 ms)

  ظù Tax Controller Tests ظ║ POST /api/tax/calculate ظ║ should handle 
missing tax rate for region

    expect(received).toBe(expected) // Object.is equality

    Expected: 404
    Received: 500

    [0m [90m 231 |[39m         })[33m;[39m
     [90m 232 |[39m
    [31m[1m>[22m[39m[90m 233 |[39m       
expect(res[33m.[39mstatusCode)[33m.[39mtoBe([35m404[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 234 |[39m     })[33m;[39m
     [90m 235 |[39m   })[33m;[39m
     [90m 236 |[39m })[33m;[39m[0m

      at toBe (__tests__/tax.test.js:233:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a498d10b7f55fcc7bb', iat: 1761677732 } computed userId: 690111a498d10b7f55fcc7bb

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 1 ids: [ '690111a498d10b7f55fcc7bb' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a498d10b7f55fcc7bb

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a498d10b7f55fcc7cd', iat: 1761677733 } computed userId: 690111a498d10b7f55fcc7cd

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a498d10b7f55fcc7bb', '690111a498d10b7f55fcc7cd' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a498d10b7f55fcc7cd

      at log (middleware/authMiddleware.js:85:15)

FAIL __tests__/middleware/authMiddleware.test.js
  Auth Middleware
    protect middleware
      ظêأ should call next() with valid token in Authorization header 
(235 ms)
      ظêأ should call next() with valid token in cookie (217 ms)
      ظêأ should throw error if no token provided (51 ms)
      ظêأ should throw error for invalid token (61 ms)
      ظêأ should throw error for expired token (65 ms)
      ظêأ should allow anonymous access to analytics events (53 ms)
    Rate Limiters
      ظêأ should allow requests within rate limit (50 ms)
      ├ù should block requests over login rate limit (58 ms)
      ظêأ should allow requests within API rate limit (50 ms)
      ├ù should block requests over API rate limit (51 ms)

  ظù Auth Middleware ظ║ Rate Limiters ظ║ should block requests over 
login rate limit

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 429

    Number of calls: 0

    [0m [90m 143 |[39m       }
     [90m 144 |[39m
    [31m[1m>[22m[39m[90m 145 |[39m       expect(mockRes[33m.[39mst
atus)[33m.[39mtoHaveBeenCalledWith([35m429[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 146 |[39m       
expect(mockRes[33m.[39mjson)[33m.[39mtoHaveBeenCalledWith({
     [90m 147 |[39m         error[33m:[39m [32m'Too many login 
attempts'[39m
     [90m 148 |[39m       })[33m;[39m[0m

      at toHaveBeenCalledWith 
(__tests__/middleware/authMiddleware.test.js:145:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  ظù Auth Middleware ظ║ Rate Limiters ظ║ should block requests over 
API rate limit

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: 429

    Number of calls: 0

    [0m [90m 170 |[39m       }
     [90m 171 |[39m
    [31m[1m>[22m[39m[90m 172 |[39m       expect(mockRes[33m.[39mst
atus)[33m.[39mtoHaveBeenCalledWith([35m429[39m)[33m;[39m
     [90m     |[39m                              [31m[1m^[22m[39m
     [90m 173 |[39m       
expect(mockRes[33m.[39mjson)[33m.[39mtoHaveBeenCalledWith({
     [90m 174 |[39m         error[33m:[39m [32m'Too many 
requests'[39m
     [90m 175 |[39m       })[33m;[39m[0m

      at toHaveBeenCalledWith 
(__tests__/middleware/authMiddleware.test.js:172:30)
      at node_modules/@babel/runtime/helpers/regeneratorRuntime.js:52:18
      at Generator.<anonymous> 
(node_modules/@babel/runtime/helpers/regenerator.js:52:51)
      at Generator.next 
(node_modules/@babel/runtime/helpers/regeneratorDefine.js:11:21)
      at asyncGeneratorStep 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next 
(node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a8de667ad0f8bd9022', iat: 1761677736, exp: 1764269736 } computed userId: 690111a8de667ad0f8bd9022

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111a8de667ad0f8bd9022', '690111a8de667ad0f8bd9024' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a8de667ad0f8bd9022

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a9de667ad0f8bd9039', iat: 1761677737, exp: 1764269737 } computed userId: 690111a9de667ad0f8bd9039

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 4 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a9de667ad0f8bd9039

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a9de667ad0f8bd9055', iat: 1761677737, exp: 1764269737 } computed userId: 690111a9de667ad0f8bd9055

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 6 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a9de667ad0f8bd9055

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a9de667ad0f8bd9071', iat: 1761677738, exp: 1764269738 } computed userId: 690111a9de667ad0f8bd9071

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 8 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a9de667ad0f8bd9071

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111a9de667ad0f8bd9071', iat: 1761677738, exp: 1764269738 } computed userId: 690111a9de667ad0f8bd9071

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 8 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111a9de667ad0f8bd9071

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111aade667ad0f8bd9094', iat: 1761677738, exp: 1764269738 } computed userId: 690111aade667ad0f8bd9094

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 10 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073',
      '690111aade667ad0f8bd9094',
      '690111aade667ad0f8bd9096'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111aade667ad0f8bd9094

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111aade667ad0f8bd9094', iat: 1761677738, exp: 1764269738 } computed userId: 690111aade667ad0f8bd9094

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 10 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073',
      '690111aade667ad0f8bd9094',
      '690111aade667ad0f8bd9096'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111aade667ad0f8bd9094

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111aade667ad0f8bd90b6', iat: 1761677739, exp: 1764269739 } computed userId: 690111aade667ad0f8bd90b6

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 12 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073',
      '690111aade667ad0f8bd9094',
      '690111aade667ad0f8bd9096',
      '690111aade667ad0f8bd90b6',
      '690111abde667ad0f8bd90b8'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111aade667ad0f8bd90b6

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111aade667ad0f8bd90b6', iat: 1761677739, exp: 1764269739 } computed userId: 690111aade667ad0f8bd90b6

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 12 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073',
      '690111aade667ad0f8bd9094',
      '690111aade667ad0f8bd9096',
      '690111aade667ad0f8bd90b6',
      '690111abde667ad0f8bd90b8'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111aade667ad0f8bd90b6

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111abde667ad0f8bd90d8', iat: 1761677739, exp: 1764269739 } computed userId: 690111abde667ad0f8bd90d8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 14 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073',
      '690111aade667ad0f8bd9094',
      '690111aade667ad0f8bd9096',
      '690111aade667ad0f8bd90b6',
      '690111abde667ad0f8bd90b8',
      '690111abde667ad0f8bd90d8',
      '690111abde667ad0f8bd90da'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111abde667ad0f8bd90d8

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111abde667ad0f8bd90d8', iat: 1761677739, exp: 1764269739 } computed userId: 690111abde667ad0f8bd90d8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 14 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073',
      '690111aade667ad0f8bd9094',
      '690111aade667ad0f8bd9096',
      '690111aade667ad0f8bd90b6',
      '690111abde667ad0f8bd90b8',
      '690111abde667ad0f8bd90d8',
      '690111abde667ad0f8bd90da'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111abde667ad0f8bd90d8

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111abde667ad0f8bd90d8', iat: 1761677739, exp: 1764269739 } computed userId: 690111abde667ad0f8bd90d8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 14 ids: [
      '690111a8de667ad0f8bd9022',
      '690111a8de667ad0f8bd9024',
      '690111a9de667ad0f8bd9039',
      '690111a9de667ad0f8bd903b',
      '690111a9de667ad0f8bd9055',
      '690111a9de667ad0f8bd9057',
      '690111a9de667ad0f8bd9071',
      '690111aade667ad0f8bd9073',
      '690111aade667ad0f8bd9094',
      '690111aade667ad0f8bd9096',
      '690111aade667ad0f8bd90b6',
      '690111abde667ad0f8bd90b8',
      '690111abde667ad0f8bd90d8',
      '690111abde667ad0f8bd90da'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111abde667ad0f8bd90d8

      at log (middleware/authMiddleware.js:85:15)

PASS __tests__/cart.test.js (6.314 s)
  Cart Endpoints
    GET /api/cart
      ظêأ should get empty cart for new user (766 ms)
      ظêأ should get cart with items (448 ms)
    POST /api/cart
      ظêأ should add item to cart (441 ms)
      ظêأ should update existing item quantity (508 ms)
    PUT /api/cart/item/:productId
      ظêأ should update item quantity (502 ms)
    DELETE /api/cart/item/:productId
      ظêأ should remove item from cart (457 ms)
    DELETE /api/cart
      ظêأ should clear cart (522 ms)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b0ab02627578b6fda6', iat: 1761677744, exp: 1764269744 } computed userId: 690111b0ab02627578b6fda6

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 12 ids: [
      '690111aeab02627578b6fd51',
      '690111aeab02627578b6fd55',
      '690111afab02627578b6fd59',
      '690111afab02627578b6fd6e',
      '690111afab02627578b6fd70',
      '690111afab02627578b6fd74',
      '690111afab02627578b6fd89',
      '690111afab02627578b6fd8b',
      '690111b0ab02627578b6fd8f',
      '690111b0ab02627578b6fda4',
      '690111b0ab02627578b6fda6',
      '690111b0ab02627578b6fdaa'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b0ab02627578b6fda6

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b0ab02627578b6fdc0', iat: 1761677745, exp: 1764269745 } computed userId: 690111b0ab02627578b6fdc0

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 15 ids: [
      '690111aeab02627578b6fd51',
      '690111aeab02627578b6fd55',
      '690111afab02627578b6fd59',
      '690111afab02627578b6fd6e',
      '690111afab02627578b6fd70',
      '690111afab02627578b6fd74',
      '690111afab02627578b6fd89',
      '690111afab02627578b6fd8b',
      '690111b0ab02627578b6fd8f',
      '690111b0ab02627578b6fda4',
      '690111b0ab02627578b6fda6',
      '690111b0ab02627578b6fdaa',
      '690111b0ab02627578b6fdc0',
      '690111b1ab02627578b6fdc2',
      '690111b1ab02627578b6fdc6'
    ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b0ab02627578b6fdc0

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:45.401Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/products","headers":{"host":"127.0.0.1:51312","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWIwYWIwMjYyNzU3OGI2ZmRjMCIsImlhdCI6MTc2MTY3Nzc0NSwiZXhwIjoxNzY0MjY5NzQ1fQ.t4vrI6nZp6sbi3As4pOBHf_rW5zlFOFcHhGL--PPgGo","content-type":"application/json","content-length":"161","connection":"close"},"query":{},"body":{"name":"New Product","description":"New Description","price":199.99,"category":"690111b1ab02627578b6fdc4","countInStock":15,"seller":"690111b1ab02627578b6fdc6"},"ip":"::ffff:127.0.0.1","userId":"690111b0ab02627578b6fdc0"}}
PASS __tests__/products.test.js (5.521 s)
  Product Endpoints
    GET /api/products
      ظêأ should fetch all products (587 ms)
      ظêأ should filter products by category (505 ms)
      ظêأ should sort products by price (506 ms)
    POST /api/products
      ظêأ should create product with admin token (562 ms)
      ظêأ should not create product without admin token (591 ms)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706649', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:48.839Z [31merror[39m: Application error {"name":"Error","message":"Not authorized, no token provided","stack":"Error: Not authorized, no token provided\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:44:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:129:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at Function.handle (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at router (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:47:12)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at logger (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\morgan\\index.js:144:5)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\body-parser\\lib\\read.js:137:5\n    at AsyncResource.runInAsyncScope (node:async_hooks:211:14)\n    at invokeCallback (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\raw-body\\index.js:238:16)\n    at done (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\raw-body\\index.js:227:7)\n    at IncomingMessage.onEnd (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\raw-body\\index.js:287:7)\n    at IncomingMessage.emit (node:events:524:28)\n    at endReadableNT (node:internal/streams/readable:1698:12)\n    at processTicksAndRejections (node:internal/process/task_queues:90:21)","request":{"method":"POST","url":"/api/support","headers":{"host":"127.0.0.1:51327","accept-encoding":"gzip, deflate","content-type":"application/json","content-length":"59","connection":"close"},"query":{},"body":{"subject":"Test Ticket","message":"This is a test ticket"},"ip":"::ffff:127.0.0.1"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706647', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706647', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706647', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706649', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706649', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706647', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706647', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706649', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:50.106Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/support/690111b6abe9c86f7d706724/status","headers":{"host":"127.0.0.1:51343","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWI0YWJlOWM4NmY3ZDcwNjY0OSIsImlhdCI6MTc2MTY3Nzc0OCwiZXhwIjoxNzY0MjY5NzQ4fQ.Fi5zQgi3DbRQQT2A1F3BRNS_aUrJa78KLuBt5zxxbmM","content-type":"application/json","content-length":"19","connection":"close"},"query":{},"body":{"status":"closed"},"ip":"::ffff:127.0.0.1","userId":"690111b4abe9c86f7d706649"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706647', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706647

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b4abe9c86f7d706649', iat: 1761677748, exp: 1764269748 } computed userId: 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b4abe9c86f7d706647', '690111b4abe9c86f7d706649' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b4abe9c86f7d706649

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:50.442Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/support/690111b6abe9c86f7d70674f/priority","headers":{"host":"127.0.0.1:51347","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWI0YWJlOWM4NmY3ZDcwNjY0OSIsImlhdCI6MTc2MTY3Nzc0OCwiZXhwIjoxNzY0MjY5NzQ4fQ.Fi5zQgi3DbRQQT2A1F3BRNS_aUrJa78KLuBt5zxxbmM","content-type":"application/json","content-length":"19","connection":"close"},"query":{},"body":{"priority":"high"},"ip":"::ffff:127.0.0.1","userId":"690111b4abe9c86f7d706649"}}
PASS __tests__/supportTicket.test.js
  Support Ticket Controller Tests
    POST /api/support
      ظêأ should create a support ticket (154 ms)
      ظêأ should require authentication (95 ms)
    GET /api/support
      ظêأ should get all tickets for admin (156 ms)
      ظêأ should filter tickets by status (156 ms)
      ظêأ should filter tickets by priority (151 ms)
    GET /api/support/my-tickets
      ظêأ should get only user tickets (151 ms)
    POST /api/support/:id/message
      ظêأ should add message to ticket (175 ms)
      ظêأ should update status when admin replies (150 ms)
    PUT /api/support/:id/status
      ظêأ should update ticket status when admin (171 ms)
      ظêأ should not allow regular users to update status (179 ms)
    PUT /api/support/:id/priority
      ظêأ should update ticket priority when admin (184 ms)
      ظêأ should not allow regular users to update priority (120 ms)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b98e87e9b6c3f8e325', iat: 1761677753, exp: 1764269753 } computed userId: 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b98e87e9b6c3f8e325', '690111b98e87e9b6c3f8e327' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b98e87e9b6c3f8e327', iat: 1761677753, exp: 1764269753 } computed userId: 690111b98e87e9b6c3f8e327

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b98e87e9b6c3f8e325', '690111b98e87e9b6c3f8e327' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b98e87e9b6c3f8e327

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:53.805Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/categories","headers":{"host":"127.0.0.1:51362","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWI5OGU4N2U5YjZjM2Y4ZTMyNyIsImlhdCI6MTc2MTY3Nzc1MywiZXhwIjoxNzY0MjY5NzUzfQ.gWOYbxxUAgJKwKsJEoz7TrtGKEJPQpLNbVZKHGFLcQ4","content-type":"application/json","content-length":"22","connection":"close"},"query":{},"body":{"name":"Electronics"},"ip":"::ffff:127.0.0.1","userId":"690111b98e87e9b6c3f8e327"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111b98e87e9b6c3f8e325', iat: 1761677753, exp: 1764269753 } computed userId: 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b98e87e9b6c3f8e325', '690111b98e87e9b6c3f8e327' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:53.940Z [31merror[39m: Application error {"name":"Error","message":"Category already exists","stack":"Error: Category already exists\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\categoryController.js:35:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/categories","headers":{"host":"127.0.0.1:51364","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWI5OGU4N2U5YjZjM2Y4ZTMyNSIsImlhdCI6MTc2MTY3Nzc1MywiZXhwIjoxNzY0MjY5NzUzfQ.SQUwI7s5ZEeCS3gXm1JVdTWQC1RXFZvqv6poTDuv_bc","content-type":"application/json","content-length":"22","connection":"close"},"query":{},"body":{"name":"Electronics"},"ip":"::ffff:127.0.0.1","userId":"690111b98e87e9b6c3f8e325"}}
2025-10-28T18:55:54.389Z [31merror[39m: Application error {"name":"Error","message":"Not Found - /api/categories/690111ba8e87e9b6c3f8e39e","stack":"Error: Not Found - /api/categories/690111ba8e87e9b6c3f8e39e\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\categoryController.js:44:24\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"GET","url":"/api/categories/690111ba8e87e9b6c3f8e39e","headers":{"host":"127.0.0.1:51372","accept-encoding":"gzip, deflate","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111b98e87e9b6c3f8e325', iat: 1761677753, exp: 1764269753 } computed userId: 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b98e87e9b6c3f8e325', '690111b98e87e9b6c3f8e327' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b98e87e9b6c3f8e327', iat: 1761677753, exp: 1764269753 } computed userId: 690111b98e87e9b6c3f8e327

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b98e87e9b6c3f8e325', '690111b98e87e9b6c3f8e327' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b98e87e9b6c3f8e327

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:54.642Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/categories/690111ba8e87e9b6c3f8e3c4","headers":{"host":"127.0.0.1:51376","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWI5OGU4N2U5YjZjM2Y4ZTMyNyIsImlhdCI6MTc2MTY3Nzc1MywiZXhwIjoxNzY0MjY5NzUzfQ.gWOYbxxUAgJKwKsJEoz7TrtGKEJPQpLNbVZKHGFLcQ4","content-type":"application/json","content-length":"30","connection":"close"},"query":{},"body":{"name":"Updated Electronics"},"ip":"::ffff:127.0.0.1","userId":"690111b98e87e9b6c3f8e327"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111b98e87e9b6c3f8e325', iat: 1761677753, exp: 1764269753 } computed userId: 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b98e87e9b6c3f8e325', '690111b98e87e9b6c3f8e327' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b98e87e9b6c3f8e325

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111b98e87e9b6c3f8e327', iat: 1761677753, exp: 1764269753 } computed userId: 690111b98e87e9b6c3f8e327

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111b98e87e9b6c3f8e325', '690111b98e87e9b6c3f8e327' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111b98e87e9b6c3f8e327

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:55:54.888Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"DELETE","url":"/api/categories/690111ba8e87e9b6c3f8e3ec","headers":{"host":"127.0.0.1:51380","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWI5OGU4N2U5YjZjM2Y4ZTMyNyIsImlhdCI6MTc2MTY3Nzc1MywiZXhwIjoxNzY0MjY5NzUzfQ.gWOYbxxUAgJKwKsJEoz7TrtGKEJPQpLNbVZKHGFLcQ4","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"690111b98e87e9b6c3f8e327"}}
PASS __tests__/category.test.js
  Category Controller Tests
    POST /api/categories
      ظêأ should create a category when admin (188 ms)
      ظêأ should not allow regular users to create categories (122 ms)
      ظêأ should not allow duplicate category names (135 ms)
    GET /api/categories
      ظêأ should return all active categories (107 ms)
      ظêأ should include category counts when requested (135 ms)
    GET /api/categories/:id
      ظêأ should get category by ID (102 ms)
      ظêأ should return 404 for non-existent category (96 ms)
    PUT /api/categories/:id
      ظêأ should update category when admin (132 ms)
      ظêأ should not allow regular users to update categories (119 ms)
    DELETE /api/categories/:id
      ظêأ should delete category when admin (127 ms)
      ظêأ should not allow regular users to delete categories (139 ms)

2025-10-28T18:55:57.740Z [31merror[39m: Application error {"name":"Error","message":"Not authorized, no token provided","stack":"Error: Not authorized, no token provided\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:44:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:129:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at Function.handle (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at router (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:47:12)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at logger (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\morgan\\index.js:144:5)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at jsonParser (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\body-parser\\lib\\types\\json.js:113:7)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:305:5)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at xFrameOptionsMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:281:3)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at strictTransportSecurityMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:239:3)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at contentSecurityPolicyMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:124:4)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at hpp (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\hpp\\lib\\index.js:146:9)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:231:5)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-mongo-sanitize\\index.js:122:5\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:105:78)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at cors (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:188:7)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:224:17\n    at callback (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:67:27)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:219:13\n    at optionsCallback (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:199:9)\n    at corsMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:204:7)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at internalNext (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:531:6)\n    at xPoweredByMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:304:3)\n    at internalNext (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:529:6)\n    at xPermittedCrossDomainPoliciesMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:297:3)","request":{"method":"GET","url":"/api/orders/myorders","headers":{"host":"127.0.0.1:51397","accept-encoding":"gzip, deflate","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1"}}
2025-10-28T18:55:57.880Z [31merror[39m: Application error {"name":"Error","message":"Invalid token. Please log in again","stack":"Error: Invalid token. Please log in again\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:121:13\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:129:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at Route.dispatch (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:119:3)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:284:15\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at Function.handle (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:175:3)\n    at router (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:47:12)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at logger (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\morgan\\index.js:144:5)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at jsonParser (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\body-parser\\lib\\types\\json.js:113:7)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:305:5)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at xFrameOptionsMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:281:3)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at strictTransportSecurityMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:239:3)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at contentSecurityPolicyMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:124:4)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at hpp (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\hpp\\lib\\index.js:146:9)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:231:5)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-mongo-sanitize\\index.js:122:5\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:105:78)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at cors (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:188:7)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:224:17\n    at callback (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\security.js:67:27)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:219:13\n    at optionsCallback (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:199:9)\n    at corsMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\cors\\lib\\index.js:204:7)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at trim_prefix (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:328:13)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:286:9\n    at Function.process_params (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:346:12)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\index.js:280:10)\n    at internalNext (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:531:6)\n    at xPoweredByMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:304:3)\n    at internalNext (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:529:6)\n    at xPermittedCrossDomainPoliciesMiddleware (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\helmet\\index.cjs:297:3)","request":{"method":"GET","url":"/api/orders/myorders","headers":{"host":"127.0.0.1:51399","accept-encoding":"gzip, deflate","authorization":"Bearer invalid.token.here","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1"}}
2025-10-28T18:55:59.259Z [33mwarn[39m: Security event detected {"type":"rate-limit-exceeded","ip":"127.0.0.1","path":"/products","limit":20,"windowMs":1000}
PASS __tests__/security.test.js
  Security Features
    Headers Security
      ظêأ should include security headers (103 ms)
    CORS
      ظêأ should allow CORS requests (88 ms)
    Authentication
      ظêأ should reject requests without token (158 ms)
      ظêأ should reject requests with invalid token (122 ms)
    Input Validation
      ظêأ should validate email format (177 ms)
      ظêأ should sanitize inputs (360 ms)
    Rate Limiting
      ظêأ should limit repeated requests (942 ms)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c4', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c8', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:02.543Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/coupons","headers":{"host":"127.0.0.1:51462","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWMyMjRiNDBhMjFmMmZkNTBjOCIsImlhdCI6MTc2MTY3Nzc2MiwiZXhwIjoxNzY0MjY5NzYyfQ.vqY3Z4SYmsU9fhl346wabBKYZ1ihs7bH5J-maSZyowE","content-type":"application/json","content-length":"173","connection":"close"},"query":{},"body":{"code":"TEST20","type":"percentage","value":20,"minPurchase":100,"maxDiscount":50,"startDate":"2025-10-28T18:56:02.500Z","endDate":"2025-11-04T18:56:02.500Z","maxUses":100},"ip":"::ffff:127.0.0.1","userId":"690111c224b40a21f2fd50c8"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c4', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c8', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c8', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:02.921Z [31merror[39m: Application error {"name":"Error","message":"Invalid or expired coupon","stack":"Error: Invalid or expired coupon\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\couponController.js:253:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/coupons/validate","headers":{"host":"127.0.0.1:51468","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWMyMjRiNDBhMjFmMmZkNTBjOCIsImlhdCI6MTc2MTY3Nzc2MiwiZXhwIjoxNzY0MjY5NzYyfQ.vqY3Z4SYmsU9fhl346wabBKYZ1ihs7bH5J-maSZyowE","content-type":"application/json","content-length":"34","connection":"close"},"query":{},"body":{"code":"INVALID","cartTotal":200},"ip":"::ffff:127.0.0.1","userId":"690111c224b40a21f2fd50c8"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c8', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:03.048Z [31merror[39m: Application error {"name":"Error","message":"Minimum purchase amount of 100 required","stack":"Error: Minimum purchase amount of 100 required\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\controllers\\couponController.js:267:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"POST","url":"/api/coupons/validate","headers":{"host":"127.0.0.1:51470","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWMyMjRiNDBhMjFmMmZkNTBjOCIsImlhdCI6MTc2MTY3Nzc2MiwiZXhwIjoxNzY0MjY5NzYyfQ.vqY3Z4SYmsU9fhl346wabBKYZ1ihs7bH5J-maSZyowE","content-type":"application/json","content-length":"33","connection":"close"},"query":{},"body":{"code":"VALID20","cartTotal":50},"ip":"::ffff:127.0.0.1","userId":"690111c224b40a21f2fd50c8"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c4', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c8', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:03.338Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"PUT","url":"/api/coupons/690111c324b40a21f2fd5159","headers":{"host":"127.0.0.1:51474","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWMyMjRiNDBhMjFmMmZkNTBjOCIsImlhdCI6MTc2MTY3Nzc2MiwiZXhwIjoxNzY0MjY5NzYyfQ.vqY3Z4SYmsU9fhl346wabBKYZ1ihs7bH5J-maSZyowE","content-type":"application/json","content-length":"12","connection":"close"},"query":{},"body":{"value":25},"ip":"::ffff:127.0.0.1","userId":"690111c224b40a21f2fd50c8"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c4', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c4

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c224b40a21f2fd50c8', iat: 1761677762, exp: 1764269762 } computed userId: 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c224b40a21f2fd50c4', '690111c224b40a21f2fd50c8' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c224b40a21f2fd50c8

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:03.575Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"DELETE","url":"/api/coupons/690111c324b40a21f2fd5182","headers":{"host":"127.0.0.1:51478","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWMyMjRiNDBhMjFmMmZkNTBjOCIsImlhdCI6MTc2MTY3Nzc2MiwiZXhwIjoxNzY0MjY5NzYyfQ.vqY3Z4SYmsU9fhl346wabBKYZ1ihs7bH5J-maSZyowE","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"690111c224b40a21f2fd50c8"}}
PASS __tests__/coupon.test.js
  Coupon Controller Tests
    POST /api/coupons
      ظêأ should create a new coupon when admin (130 ms)
      ظêأ should not allow regular users to create coupons (110 ms)
    GET /api/coupons
      ظêأ should return all coupons for admin (136 ms)
    POST /api/coupons/validate
      ظêأ should validate a valid coupon (111 ms)
      ظêأ should reject invalid coupon code (127 ms)
      ظêأ should reject when cart total is below minimum purchase (128 ms)
    PUT /api/coupons/:id
      ظêأ should update coupon when admin (155 ms)
      ظêأ should not allow regular users to update coupons (132 ms)
    DELETE /api/coupons/:id
      ظêأ should delete coupon when admin (127 ms)
      ظêأ should not allow regular users to delete coupons (114 ms)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c63447efb95722337b', iat: 1761677766, exp: 1764269766 } computed userId: 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c63447efb95722337b', '690111c63447efb95722337d' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c63447efb95722337b', iat: 1761677766, exp: 1764269766 } computed userId: 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c63447efb95722337b', '690111c63447efb95722337d' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c63447efb95722337d', iat: 1761677766, exp: 1764269766 } computed userId: 690111c63447efb95722337d

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c63447efb95722337b', '690111c63447efb95722337d' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c63447efb95722337d

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:07.140Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"GET","url":"/api/analytics","headers":{"host":"127.0.0.1:51499","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWM2MzQ0N2VmYjk1NzIyMzM3ZCIsImlhdCI6MTc2MTY3Nzc2NiwiZXhwIjoxNzY0MjY5NzY2fQ.9NO5qfdCHqMxmlnouOlhBNNfe39YIK9udaWuAwy__x0","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"690111c63447efb95722337d"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111c63447efb95722337b', iat: 1761677766, exp: 1764269766 } computed userId: 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c63447efb95722337b', '690111c63447efb95722337d' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c63447efb95722337d', iat: 1761677766, exp: 1764269766 } computed userId: 690111c63447efb95722337d

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c63447efb95722337b', '690111c63447efb95722337d' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c63447efb95722337d

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:07.420Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"GET","url":"/api/analytics/user/690111c63447efb95722337d","headers":{"host":"127.0.0.1:51503","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWM2MzQ0N2VmYjk1NzIyMzM3ZCIsImlhdCI6MTc2MTY3Nzc2NiwiZXhwIjoxNzY0MjY5NzY2fQ.9NO5qfdCHqMxmlnouOlhBNNfe39YIK9udaWuAwy__x0","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"690111c63447efb95722337d"}}
  console.log
    AUTH DEBUG - decoded token: { id: '690111c63447efb95722337b', iat: 1761677766, exp: 1764269766 } computed userId: 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c63447efb95722337b', '690111c63447efb95722337d' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c63447efb95722337b

      at log (middleware/authMiddleware.js:85:15)

  console.log
    AUTH DEBUG - decoded token: { id: '690111c63447efb95722337d', iat: 1761677766, exp: 1764269766 } computed userId: 690111c63447efb95722337d

      at log (middleware/authMiddleware.js:66:15)

  console.log
    AUTH DEBUG - users in DB count: 2 ids: [ '690111c63447efb95722337b', '690111c63447efb95722337d' ]

      at log (middleware/authMiddleware.js:74:17)

  console.log
    AUTH DEBUG - user lookup result: true 690111c63447efb95722337d

      at log (middleware/authMiddleware.js:85:15)

2025-10-28T18:56:07.739Z [31merror[39m: Application error {"name":"Error","message":"Not authorized as an admin","stack":"Error: Not authorized as an admin\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:133:11\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:22:7\n    at new Promise (<anonymous>)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:14:12\n    at apply (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:136:2)\n    at asyncUtilWrap (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express-async-handler\\index.js:3:20)\n    at Layer.handle [as handle_request] (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\layer.js:95:5)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\express\\lib\\router\\route.js:149:13)\n    at next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\middleware\\authMiddleware.js:118:5)\n    at C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorRuntime.js:52:18\n    at Generator.<anonymous> (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regenerator.js:52:51)\n    at Generator.next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\regeneratorDefine.js:11:21)\n    at asyncGeneratorStep (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:3:17)\n    at _next (C:\\Users\\DREAMS\\Desktop\\DEPI-graduation-project-backend\\node_modules\\@babel\\runtime\\helpers\\asyncToGenerator.js:17:9)\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)","request":{"method":"GET","url":"/api/analytics/products","headers":{"host":"127.0.0.1:51507","accept-encoding":"gzip, deflate","authorization":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY5MDExMWM2MzQ0N2VmYjk1NzIyMzM3ZCIsImlhdCI6MTc2MTY3Nzc2NiwiZXhwIjoxNzY0MjY5NzY2fQ.9NO5qfdCHqMxmlnouOlhBNNfe39YIK9udaWuAwy__x0","connection":"close"},"query":{},"body":{},"ip":"::ffff:127.0.0.1","userId":"690111c63447efb95722337d"}}
PASS __tests__/analytics.test.js
  Analytics Controller Tests
    POST /api/analytics/event
      ظêأ should track an event with user ID (117 ms)
      ظêأ should track an event without user ID (106 ms)
    GET /api/analytics
      ظêأ should get analytics with date range filter (168 ms)
      ظêأ should filter analytics by event type (151 ms)
      ظêأ should not allow non-admin users to access analytics (146 ms)
    GET /api/analytics/user/:userId
      ظêأ should get user activity (136 ms)
      ظêأ should not allow non-admin users to access user activity (130 
ms)
    GET /api/analytics/products
      ظêأ should get product analytics (183 ms)
      ظêأ should not allow non-admin users to access product analytics 
(137 ms)

-----------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------
File                         | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                             
-----------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------
All files                    |   69.32 |    50.85 |   62.31 |    70.5 |                                                                                                                               
 controllers                 |   67.06 |    53.79 |    73.1 |   67.67 |                                                                                                                               
  analyticsController.js     |   92.45 |    66.66 |     100 |   92.15 | 12,32,80,105                                                                                                                  
  authController.js          |   22.22 |     7.69 |   14.28 |   22.22 | 15-16,37-38,46-60,68-81,89-111,119-134,141-183,191-225                                                                        
  cartController.js          |   81.94 |    68.18 |     100 |   82.08 | 26-27,32-33,71-72,77-78,83-84,101-102                                                                                         
  categoryController.js      |   89.09 |       68 |     100 |   97.91 | 29                                                                                                                            
  couponController.js        |   56.55 |    52.04 |   71.42 |   56.55 | 11,28,34,39,43,47,56,61,65,91,102,120-135,144,149,155,162,168,173,176,194-198,212,217,223,241,245,258,263,275,280,285,307-354 
  newsletterController.js    |   88.73 |     61.9 |   85.71 |   93.65 | 19,105-108                                                                                                                    
  orderController.js         |   66.66 |    66.66 |      75 |   66.66 | 19-20,65-66,82-98                                                                                                             
  paymentController.js       |   66.89 |    55.88 |      70 |   69.01 | 11-16,21-22,41-42,65-66,73-74,134-135,155,160-161,172,176,181,187,236-242,269,287,301,308-311,319,332-335,358-385             
  productController.js       |   39.09 |    32.75 |   23.07 |      40 | 18,22,40,71-79,105-106,114-134,142-145,152-184,192-194,201-206,213-217,224-253                                                
  returnController.js        |   76.92 |       50 |      80 |   76.92 | 19-20,93-106,141-142                                                                                                          
  shippingController.js      |   75.47 |    71.42 |   66.66 |   75.47 | 51-57,80-81,89-96                                                                                                             
  subcategoryController.js   |   81.42 |    52.94 |     100 |   80.59 | 11-14,30-35,58-60,119-120,136-137                                                                                             
  supportTicketController.js |   72.22 |    57.69 |   85.71 |   72.46 | 42,82-95,110-111,140,145-146,177,182-183,199-200                                                                              
  taxController.js           |   76.66 |    68.42 |   66.66 |   76.66 | 59-65,96-97,105-112,145                                                                                                       
  wishlistController.js      |   75.71 |    58.33 |      80 |   75.36 | 31-33,52-54,85-95,118-119,123,127                                                                                             
 middleware                  |   73.02 |    57.14 |   47.91 |   74.46 |                                                                                                                               
  authMiddleware.js          |   89.28 |    68.18 |     100 |   89.09 | 77,95,100,108,113,127                                                                                                         
  errorMiddleware.js         |      55 |    58.33 |   33.33 |   56.41 | 5-12,23-29,39-41,52,61,71,80,90,100,110,134                                                                                   
  morganLogger.js            |   85.71 |      100 |      50 |   83.33 | 6                                                                                                                             
  optionalAuth.js            |   84.21 |       75 |     100 |   84.21 | 14,35-36                                                                                                                      
  security.js                |   73.48 |     62.9 |   39.13 |   76.42 | 74,114-115,133,145-164,195,209,221-223,310-313,344-345,352,358,369-384                                                        
  validationMiddleware.js    |   95.23 |       75 |     100 |   94.73 | 15                                                                                                                            
  validationRules.js         |   57.57 |    12.12 |   27.27 |   59.37 | 26-32,52-60,70,79-80,89-98,104,137,168-173,418-421                                                                            
 models                      |   59.09 |    22.11 |   44.44 |   63.58 |                                                                                                                               
  analyticsModel.js          |     100 |      100 |     100 |     100 |                                                                                                                               
  cartModel.js               |     100 |      100 |     100 |     100 |                                                                                                                               
  categoryModel.js           |      90 |    83.33 |     100 |      90 | 40                                                                                                                            
  couponModel.js             |   46.15 |        0 |   33.33 |      50 | 85-86,96-101                                                                                                                  
  newsletterModel.js         |     100 |      100 |     100 |     100 |                                                                                                                               
  orderModel.js              |     100 |      100 |     100 |     100 |                                                                                                                               
  productModel.js            |   53.33 |       25 |      20 |   57.14 | 227-228,235,247-266,283                                                                                                       
  returnModel.js             |     100 |      100 |     100 |     100 |                                                                                                                               
  shippingModel.js           |   18.18 |        0 |       0 |      20 | 45-69                                                                                                                         
  subcategoryModel.js        |     100 |      100 |     100 |     100 |                                                                                                                               
  supportTicketModel.js      |    90.9 |    55.55 |     100 |   95.23 | 109                                                                                                                           
  taxModel.js                |   20.83 |        0 |       0 |   26.31 | 68-90                                                                                                                         
  userModel.js               |   55.55 |       20 |    37.5 |   59.52 | 47,83,102-104,110-121,127-138                                                                                                 
  wishlistModel.js           |     100 |      100 |     100 |     100 |                                                                                                                               
 routes                      |     100 |      100 |     100 |     100 |                                                                                                                               
  analyticsRoutes.js         |     100 |      100 |     100 |     100 |                                                                                                                               
  authRoutes.js              |     100 |      100 |     100 |     100 |                                                                                                                               
  cartRoutes.js              |     100 |      100 |     100 |     100 |                                                                                                                               
  categoryRoutes.js          |     100 |      100 |     100 |     100 |                                                                                                                               
  couponRoutes.js            |     100 |      100 |     100 |     100 |                                                                                                                               
  newsletterRoutes.js        |     100 |      100 |     100 |     100 |                                                                                                                               
  orderRoutes.js             |     100 |      100 |     100 |     100 |                                                                                                                               
  paymentRoutes.js           |     100 |      100 |     100 |     100 |                                                                                                                               
  productRoutes.js           |     100 |      100 |     100 |     100 |                                                                                                                               
  returnsRoutes.js           |     100 |      100 |     100 |     100 |                                                                                                                               
  shippingRoutes.js          |     100 |      100 |     100 |     100 |                                                                                                                               
  subcategoryRoutes.js       |     100 |      100 |     100 |     100 |                                                                                                                               
  supportRoutes.js           |     100 |      100 |     100 |     100 |                                                                                                                               
  taxRoutes.js               |     100 |      100 |     100 |     100 |                                                                                                                               
  wishlistRoutes.js          |     100 |      100 |     100 |     100 |                                                                                                                               
 utils                       |   38.09 |    33.33 |      40 |   38.09 |                                                                                                                               
  appError.js                |     100 |       50 |     100 |     100 | 5                                                                                                                             
  fileUpload.js              |       0 |        0 |       0 |       0 | 1-47                                                                                                                          
  generateToken.js           |     100 |    66.66 |     100 |     100 | 6-9                                                                                                                           
  logger.js                  |     100 |       50 |     100 |     100 | 4                                                                                                                             
  sendEmail.js               |       0 |        0 |       0 |       0 | 1-31                                                                                                                          
-----------------------------|---------|----------|---------|---------|-------------------------------------------------------------------------------------------------------------------------------
Test Suites: 9 failed, 7 passed, 16 total
Tests:       17 failed, 125 passed, 142 total
Snapshots:   0 total
Time:        82.654 s
Ran all test suites.
